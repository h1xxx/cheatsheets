<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent Data Viewer (AG Grid - Category Dropdown)</title>

    <!-- AG Grid Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
    <!-- AG Grid Theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-alpine.css" />

    <!-- Custom CSS -->
    <style>
        /* Basic page setup */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Makes width/height include padding/border */
        }

        body {
            font-family: sans-serif;
            padding: 20px;
            display: flex; /* Use flexbox for overall layout */
            flex-direction: column; /* Stack elements vertically */
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0; /* Prevent heading from shrinking */
        }

        /* Filter controls container layout */
        .filters-container {
            display: grid; /* Use CSS Grid for filter layout */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responsive columns */
            gap: 15px; /* Spacing between grid items */
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            flex-shrink: 0; /* Prevent filter container from shrinking */
        }

        .filters-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .filters-container input,
        .filters-container select {
            width: 100%; /* Full width within their grid cell */
            padding: 8px;
            box-sizing: border-box; /* Include padding in width */
            border: 1px solid #ccc;
            border-radius: 3px;
            height: 35px; /* Consistent height for inputs/selects */
        }

        /* Style the clear button */
        .filters-container button {
             padding: 8px 15px;
             cursor: pointer;
             height: 35px; /* Match input height */
             align-self: end; /* Align button to the bottom of its grid cell */
        }
        #clear-filters {
             grid-column: 1 / -1; /* Make clear button span all columns */
             justify-self: start; /* Align to the start of the grid area */
             margin-top: 10px; /* Add some space above it */
        }

        /* Grid container setup */
        #grid-container {
            flex-grow: 1; /* Allow grid container to take remaining vertical space */
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for flex-grow in nested flex containers */
        }

        /* AG Grid specific styles */
        #myGrid {
            flex-grow: 1; /* Allow AG Grid itself to fill the grid-container */
            width: 100%;
            min-height: 400px; /* Minimum height for the grid */
            margin-bottom: 20px;
        }

        /* Helper classes for text alignment in AG Grid cells/headers */
        .ag-cell.text-right,
        .ag-header-cell.text-right .ag-header-cell-label {
            text-align: right !important; /* Force right alignment */
        }
        .ag-cell.text-center,
        .ag-header-cell.text-center .ag-header-cell-label {
            text-align: center !important; /* Force center alignment */
        }

        /* Loading indicator styles */
        #loading-indicator {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #007bff;
            flex-shrink: 0; /* Prevent indicator from shrinking */
        }
    </style>
</head>
<body>

    <h1>Torrent Data</h1>

    <!-- Filter Controls Section -->
    <div class="filters-container">
        <div>
            <label for="filter-name">Name contains:</label>
            <input type="text" id="filter-name" placeholder="e.g., kali linux">
        </div>
        <div>
            <label for="filter-category">Category:</label>
            <select id="filter-category">
                <option value="">All Categories</option>
                <!-- Options populated dynamically by JavaScript -->
            </select>
        </div>
        <div>
            <label for="filter-min-size">Min Size (MB):</label>
            <input type="number" id="filter-min-size" placeholder="e.g., 1000" min="0">
        </div>
         <div>
            <label for="filter-max-size">Max Size (MB):</label>
            <input type="number" id="filter-max-size" placeholder="e.g., 5000" min="0">
        </div>
        <div>
            <label for="filter-is_ru">Is Russian?</label>
            <select id="filter-is_ru">
                <option value="">Any</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>
        </div>
         <div>
            <label for="filter-min-dht">Min DHT Hits:</label>
            <input type="number" id="filter-min-dht" placeholder="e.g., 1000" min="0">
        </div>
         <button id="clear-filters">Clear All Filters</button>
    </div>
    <!-- End Filter Controls Section -->

    <!-- Loading Indicator -->
    <div id="loading-indicator">Loading Table...</div>

    <!-- AG Grid Container -->
    <div id="grid-container">
        <div id="myGrid" class="ag-theme-alpine"></div>
        <!-- AG Grid will be initialized here by JavaScript -->
    </div>
    <!-- End AG Grid Container -->


    <!-- ========= JAVASCRIPT SECTION ========= -->

    <!-- Load AG Grid Library -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>

    <!-- Sample Data (In a real application, this would likely come from an API) -->
    <script>
        const torrentData = [
          { hash_id:"b573e7a597f470fc", name: "kali-linux-2024.4-installer-amd64.iso", size: 4373655552, file_count: 1, first_seen: "2024-12-12T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "misc", dht_hits: 12408, peer_hits: 125 },
          { hash_id:"7b1490474e51536e", name: "kali-linux-2024.3-installer-amd64.iso", size: 4330174464, file_count: 1, first_seen: "2024-09-11T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "misc", dht_hits: 7948, peer_hits: 88 },
          { hash_id:"9fc151c1873df628", name: "kali-linux-2024.4-live-amd64.iso", size: 5041469440, file_count: 1, first_seen: "2024-12-11T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "misc", dht_hits: 6404, peer_hits: 136 },
          { hash_id:"a1b2c3d4e5f6a7b8", name: "ubuntu-24.04-desktop-amd64.iso", size: 3145728000, file_count: 1, first_seen: "2024-04-25T00:00:00Z", last_seen: "2025-03-31T00:00:00Z", is_ru: false, is_han: false, category: "linux", dht_hits: 25000, peer_hits: 512 },
          { hash_id:"f8e7d6c5b4a3f2e1", name: "some_movie_russian_translation.mkv", size: 1572864000, file_count: 1, first_seen: "2024-10-01T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: true, is_han: false, category: "movies", dht_hits: 500, peer_hits: 25 },
          { hash_id:"abcdef1234567890", name: "another_movie_original_audio.mp4", size: 2097152000, file_count: 1, first_seen: "2024-11-15T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "movies", dht_hits: 1234, peer_hits: 56 },
          { hash_id:"fedcba9876543210", name: "linux_distro_image.img", size: 471859200, file_count: 1, first_seen: "2023-01-10T00:00:00Z", last_seen: "2025-02-28T00:00:00Z", is_ru: false, is_han: false, category: "linux", dht_hits: 8888, peer_hits: 111 },
          { hash_id:"1122334455667788", name: "archive_files.zip", size: 104857600, file_count: 50, first_seen: "2024-07-01T00:00:00Z", last_seen: "2025-03-15T00:00:00Z", is_ru: false, is_han: false, category: null, dht_hits: 300, peer_hits: 15 }, // Example with null category
        ];
    </script>

    <!-- AG Grid Initialization and Custom Logic -->
    <script>
        // Wait for the DOM to be fully loaded before executing script
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const categorySelect = document.getElementById('filter-category');
            const nameInput = document.getElementById('filter-name');
            const minSizeInput = document.getElementById('filter-min-size');
            const maxSizeInput = document.getElementById('filter-max-size');
            const isRuSelect = document.getElementById('filter-is_ru');
            const minDhtInput = document.getElementById('filter-min-dht');
            const clearFiltersButton = document.getElementById('clear-filters');
            const gridDiv = document.querySelector('#myGrid'); // AG Grid container

            let gridApi; // To hold the AG Grid API instance

            // --- Helper Functions ---

            /**
             * Formats file size in bytes to a readable string (KB, MB, GB, TB).
             * @param {number|null|undefined} bytes - The size in bytes.
             * @returns {string} Formatted size string.
             */
            function formatSize(bytes) {
                if (bytes === 0 || !bytes) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                // Ensure index is within bounds, even for very large/small numbers
                const correctedIndex = Math.max(0, Math.min(i, sizes.length - 1));
                // Format to 1 decimal place and append the unit
                return parseFloat((bytes / Math.pow(k, correctedIndex)).toFixed(1)) + ' ' + sizes[correctedIndex];
            }

            /**
             * Formats an ISO date string (or Date object) to 'YYYY-MM-DD'.
             * Handles invalid dates gracefully.
             * @param {string|Date|null|undefined} dateString - The date string or object.
             * @returns {string} Formatted date string or original string if invalid.
             */
            function formatDate(dateString) {
                if (!dateString) return ''; // Handle null or empty input
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString; // Return original if date is invalid
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error("Error formatting date:", dateString, e);
                    return dateString; // Return original on error
                }
            }

            /**
             * Creates a debounced function that delays invoking func until after wait milliseconds
             * have elapsed since the last time the debounced function was invoked.
             * Useful for rate-limiting events like input changes.
             * @param {Function} func - The function to debounce.
             * @param {number} wait - The number of milliseconds to delay.
             * @returns {Function} The new debounced function.
             */
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // --- Category Filter Population ---

            /**
             * Extracts unique categories from the torrentData, sorts them,
             * and populates the category filter dropdown.
             */
            function populateCategoryFilter() {
                console.log('Populating category filter...');
                // Use a Set to get unique values automatically
                const uniqueCategories = [...new Set(
                    torrentData
                        .map(item => item.category) // Get all category values
                        .filter(cat => cat)        // Filter out null, undefined, or empty string categories
                )].sort(); // Sort the unique categories alphabetically

                // Clear existing options (except the default "All Categories")
                // categorySelect.innerHTML = '<option value="">All Categories</option>'; // Alternative way

                // Add each unique category as an <option>
                uniqueCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category; // Text displayed to the user
                    categorySelect.appendChild(option);
                });
                console.log('Category filter populated with:', uniqueCategories);
            }

            // --- AG Grid Configuration ---

            // Define the columns for the grid
            const columnDefs = [
                { headerName: "Hash ID", field: "hash_id", filter: 'agTextColumnFilter', width: 160, suppressMenu: true }, // Example: Hide column menu
                { headerName: "Name", field: "name", filter: 'agTextColumnFilter', width: 400, wrapText: true, autoHeight: true }, // Allow text wrapping
                {
                    headerName: "Size", field: "size", filter: 'agNumberColumnFilter', width: 120,
                    cellClass: 'text-right', // Apply custom CSS class for right alignment
                    headerClass: 'text-right', // Align header text too
                    valueFormatter: params => formatSize(params.value) // Use helper to format size
                },
                {
                    headerName: "Files", field: "file_count", type: 'numericColumn', // Use built-in numeric type (right-aligned)
                    filter: 'agNumberColumnFilter', width: 90
                },
                {
                    headerName: "First Seen", field: "first_seen", filter: 'agDateColumnFilter', width: 140,
                    valueFormatter: params => formatDate(params.value), // Use helper to format date
                    // Provide a Date object to the date filter for correct comparison
                    valueGetter: params => params.data.first_seen ? new Date(params.data.first_seen) : null,
                    filterParams: {
                      comparator: function(filterLocalDateAtMidnight, cellValue) {
                        // Custom comparator for date filter if needed
                         if (cellValue == null) return -1;
                         const cellDate = new Date(cellValue);
                         if (cellDate < filterLocalDateAtMidnight) return -1;
                         if (cellDate > filterLocalDateAtMidnight) return 1;
                         return 0;
                      }
                    }
                },
                {
                    headerName: "Last Seen", field: "last_seen", filter: 'agDateColumnFilter', width: 140,
                    valueFormatter: params => formatDate(params.value),
                    valueGetter: params => params.data.last_seen ? new Date(params.data.last_seen) : null,
                    filterParams: { /* similar comparator could be added if needed */ }
                },
                {
                    headerName: "Is RU", field: "is_ru", width: 90,
                    cellClass: 'text-center', headerClass: 'text-center',
                    filter: 'agSetColumnFilter', // Use Set Filter for boolean-like values
                    valueFormatter: params => params.value ? 'Yes' : 'No', // Display 'Yes'/'No'
                    filterParams: { values: ['Yes', 'No'] } // Provide values for the Set Filter
                },
                {
                    headerName: "Is Han", field: "is_han", width: 90, // Assuming 'Han' means something specific (e.g., language)
                    cellClass: 'text-center', headerClass: 'text-center',
                    filter: 'agSetColumnFilter',
                    valueFormatter: params => params.value ? 'Yes' : 'No',
                    filterParams: { values: ['Yes', 'No'] }
                },
                {
                    headerName: "Category", field: "category",
                    filter: true, // Enable basic AG Grid filtering (can work alongside external)
                    width: 120
                },
                {
                    headerName: "DHT Hits", field: "dht_hits", type: 'numericColumn',
                    filter: 'agNumberColumnFilter', width: 120,
                    valueFormatter: params => params.value?.toLocaleString() ?? '0' // Format number with commas, handle null
                },
                {
                    headerName: "Peer Hits", field: "peer_hits", type: 'numericColumn',
                    filter: 'agNumberColumnFilter', width: 120,
                    valueFormatter: params => params.value?.toLocaleString() ?? '0'
                }
            ];

            // AG Grid Options object
            const gridOptions = {
                // Core Definitions
                columnDefs: columnDefs,
                rowData: null, // Data will be loaded in onGridReady

                // Default Column Settings (applied to all columns unless overridden)
                defaultColDef: {
                    sortable: true,     // Allow sorting
                    resizable: true,    // Allow resizing
                    filter: true,       // Enable built-in column filters
                    suppressMenu: false // Show the default column menu (for filter, etc.)
                },

                // Pagination
                pagination: true,
                paginationPageSize: 50, // Default number of rows per page
                paginationPageSizeSelector: [10, 25, 50, 100, 250, 500], // Options for rows per page

                // External Filtering (using the custom filter controls above the grid)
                isExternalFilterPresent: isExternalFilterPresent, // Function to check if external filter is active
                doesExternalFilterPass: doesExternalFilterPass,   // Function to apply the external filter logic to each row

                // Grid Events
                onGridReady: (params) => {
                    console.log('AG Grid is Ready');
                    gridApi = params.api; // Store the grid API for later use
                    // Load data into the grid (using a small delay to ensure data variable is ready - good practice if data was async)
                    setTimeout(() => {
                        if (typeof torrentData !== 'undefined') {
                            gridApi.setGridOption('rowData', torrentData);
                            console.log('Torrent data loaded into grid.');
                        } else {
                            console.error("Global 'torrentData' is not defined when grid ready!");
                        }
                        loadingIndicator.style.display = 'none'; // Hide loading indicator
                    }, 50); // Short delay
                },

                // Performance & Sizing Tweaks (Optional)
                suppressBrowserResizeObserver: true, // Might improve performance slightly in some cases
                // The following can impact performance negatively if true with large datasets, keep false unless needed
                suppressColumnVirtualisation: false,
                suppressRowVirtualisation: false,
                ensureDomOrder: true, // Helps with accessibility/testing
                accentedSort: true // Consider accented characters during sorting
            };

            // --- External Filter State and Logic ---

            // Object to hold the current state of the external filters
            const externalFilterState = {
                name: '',
                category: '',
                minSizeMB: null,
                maxSizeMB: null,
                is_ru: '', // Stores 'true', 'false', or '' (Any)
                minDht: null
            };

            /**
             * Reads values from the filter input elements and updates the externalFilterState.
             * Then, triggers AG Grid to re-apply the filter.
             */
            function updateExternalFilterState() {
                externalFilterState.name = nameInput.value.toLowerCase().trim();
                externalFilterState.category = categorySelect.value; // Value from the <select> dropdown
                externalFilterState.minSizeMB = parseFloat(minSizeInput.value) || null; // Use null if empty or invalid
                externalFilterState.maxSizeMB = parseFloat(maxSizeInput.value) || null;
                externalFilterState.is_ru = isRuSelect.value; // 'true', 'false', or ''
                externalFilterState.minDht = parseInt(minDhtInput.value) || null;

                console.log('External filter state updated:', externalFilterState);

                // Tell AG Grid that the external filter has changed
                if (gridApi) {
                    gridApi.onFilterChanged(); // This will trigger isExternalFilterPresent and doesExternalFilterPass
                }
            }

            /**
             * Called by AG Grid. Should return true if any external filter is active.
             * @returns {boolean} True if any filter has a value, false otherwise.
             */
            function isExternalFilterPresent() {
                const isActive = externalFilterState.name !== '' ||
                               externalFilterState.category !== '' ||
                               externalFilterState.minSizeMB !== null ||
                               externalFilterState.maxSizeMB !== null ||
                               externalFilterState.is_ru !== '' ||
                               externalFilterState.minDht !== null;
                // console.log('isExternalFilterPresent called, result:', isActive);
                return isActive;
            }

            /**
             * Called by AG Grid for each row. Should return true if the row passes the external filter.
             * @param {object} node - The AG Grid node object, node.data contains the row data.
             * @returns {boolean} True if the row should be included, false otherwise.
             */
            function doesExternalFilterPass(node) {
                const rowData = node.data;
                const minSizeBytes = externalFilterState.minSizeMB !== null ? externalFilterState.minSizeMB * 1024 * 1024 : 0;
                // Use Infinity for max size if not specified, allowing sizes greater than the max filter value if it's empty
                const maxSizeBytes = externalFilterState.maxSizeMB !== null ? externalFilterState.maxSizeMB * 1024 * 1024 : Infinity;

                // --- Apply each filter check ---

                // Name filter (case-insensitive partial match)
                if (externalFilterState.name && !(rowData.name?.toLowerCase() || '').includes(externalFilterState.name)) {
                    return false; // Fails name filter
                }

                // Category filter (exact match, allows filtering for 'null' if needed, but currently based on dropdown value)
                // If 'All Categories' (value='') is selected, this check passes.
                if (externalFilterState.category && rowData.category !== externalFilterState.category) {
                     // Handle potential null category in data if the filter expects a string
                     if (externalFilterState.category === 'null' && rowData.category === null) {
                        // Explicitly allow matching null if filter is set to 'null' (though dropdown doesn't currently allow this)
                     } else {
                        return false; // Fails category filter
                     }
                }

                // Size filter (check against calculated byte values)
                const size = rowData.size ?? 0; // Default to 0 if size is null/undefined
                if (size < minSizeBytes || size > maxSizeBytes) {
                    return false; // Fails size filter
                }

                // Is RU filter (compare string representations: 'true'/'false')
                // Passes if filter is '' (Any)
                if (externalFilterState.is_ru !== "" && String(rowData.is_ru ?? false) !== externalFilterState.is_ru) {
                     // Default is_ru to false if null/undefined in data
                    return false; // Fails Is RU filter
                }

                // Min DHT Hits filter
                 if (externalFilterState.minDht !== null && (rowData.dht_hits ?? 0) < externalFilterState.minDht) {
                     // Default dht_hits to 0 if null/undefined
                    return false; // Fails Min DHT filter
                 }

                // If all checks passed
                return true;
            }

            // Debounced version of the filter update function for text/number inputs
            const debouncedFilterUpdate = debounce(updateExternalFilterState, 350); // Update 350ms after user stops typing

            // --- Setup Event Listeners for Filter Controls ---

            nameInput.addEventListener('input', debouncedFilterUpdate); // Use debounce for typing
            minSizeInput.addEventListener('input', debouncedFilterUpdate);
            maxSizeInput.addEventListener('input', debouncedFilterUpdate);
            minDhtInput.addEventListener('input', debouncedFilterUpdate);

            categorySelect.addEventListener('change', updateExternalFilterState); // Use 'change' for select dropdowns
            isRuSelect.addEventListener('change', updateExternalFilterState);     // Use 'change' for select dropdowns

            // Clear Filters Button
            clearFiltersButton.addEventListener('click', () => {
                console.log('Clearing all filters...');
                // Reset input fields
                nameInput.value = '';
                categorySelect.value = ''; // Reset category dropdown to "All Categories"
                minSizeInput.value = '';
                maxSizeInput.value = '';
                isRuSelect.value = ''; // Reset Is RU dropdown to "Any"
                minDhtInput.value = '';

                // Update the state object immediately
                updateExternalFilterState();

                // Also clear any AG Grid internal filters (e.g., if user used column filters)
                if(gridApi) {
                    gridApi.setFilterModel(null); // Clears all column filters
                    console.log('AG Grid internal filters cleared.');
                }
            });


            // --- Initialize AG Grid ---

            // Populate the dynamic filters *before* creating the grid if needed (like categories)
            populateCategoryFilter();

            // Show loading indicator while grid initializes
            loadingIndicator.style.display = 'block';

            // Find the grid container and create the grid
            if (gridDiv) {
                 console.log('Creating AG Grid instance...');
                 // Create the grid using the container and options
                 agGrid.createGrid(gridDiv, gridOptions);

                 // Optional: Add a resize listener if you need complex resizing logic,
                 // though AG Grid handles basic resizing automatically.
                 // window.addEventListener('resize', () => {
                 //   if(gridApi) {
                 //      // gridApi.sizeColumnsToFit(); // Example: Fit columns on resize
                 //   }
                 // });
            } else {
                // Error handling if the grid container isn't found
                console.error("AG Grid container '#myGrid' not found in the DOM.");
                loadingIndicator.innerText = "Error: Grid container not found.";
                loadingIndicator.style.display = 'block'; // Keep indicator visible with error
            }

        }); // End DOMContentLoaded listener
    </script>

</body>
</html>