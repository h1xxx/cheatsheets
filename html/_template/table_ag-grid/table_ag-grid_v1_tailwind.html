<!DOCTYPE html>
<!-- Added h-full to html tag for proper height inheritance -->
<html lang="en" class="h-full m-0 p-0">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent Data Viewer (Tailwind CSS - Corrected)</title>

    <!-- AG Grid Core CSS (Still Required) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
    <!-- AG Grid Theme (Still Required) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-alpine.css" />

    <!-- Tailwind CSS Play CDN (for demonstration) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Optional: Tailwind Custom Configuration (via script tag for Play CDN) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            // You can add custom theme values here if needed
          }
        }
      }
    </script>

</head>
<!-- Body styles with flex layout -->
<body class="h-full m-0 p-5 font-sans flex flex-col bg-gray-50">

    <h1 class="text-2xl font-bold text-center mb-5 flex-shrink-0">Torrent Data</h1>

    <!-- Filter Controls Section -->
    <!-- Use grid for layout, responsive columns, spacing, padding, border, background -->
    <div class="grid grid-cols-[repeat(auto-fit,minmax(180px,1fr))] gap-4 mb-5 p-4 border border-gray-300 rounded-md bg-gray-100 flex-shrink-0">
        <div>
            <!-- Label styles -->
            <label for="filter-name" class="block mb-1 font-bold text-sm text-gray-700">Name contains:</label>
            <!-- Input styles: full width, padding, border, rounded corners, consistent height -->
            <input type="text" id="filter-name" placeholder="e.g., kali linux" class="w-full p-2 border border-gray-300 rounded h-[35px] text-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label for="filter-category" class="block mb-1 font-bold text-sm text-gray-700">Category:</label>
            <!-- Select styles similar to input -->
            <select id="filter-category" class="w-full p-2 border border-gray-300 rounded bg-white h-[35px] text-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Categories</option>
                <!-- Options populated dynamically by JavaScript -->
            </select>
        </div>
        <div>
            <label for="filter-min-size" class="block mb-1 font-bold text-sm text-gray-700">Min Size (MB):</label>
            <input type="number" id="filter-min-size" placeholder="e.g., 1000" min="0" class="w-full p-2 border border-gray-300 rounded h-[35px] text-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
         <div>
            <label for="filter-max-size" class="block mb-1 font-bold text-sm text-gray-700">Max Size (MB):</label>
            <input type="number" id="filter-max-size" placeholder="e.g., 5000" min="0" class="w-full p-2 border border-gray-300 rounded h-[35px] text-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label for="filter-is_ru" class="block mb-1 font-bold text-sm text-gray-700">Is Russian?</label>
            <select id="filter-is_ru" class="w-full p-2 border border-gray-300 rounded bg-white h-[35px] text-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">Any</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>
        </div>
         <div>
            <label for="filter-min-dht" class="block mb-1 font-bold text-sm text-gray-700">Min DHT Hits:</label>
            <input type="number" id="filter-min-dht" placeholder="e.g., 1000" min="0" class="w-full p-2 border border-gray-300 rounded h-[35px] text-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
         <!-- Button styles: Padding, alignment, colors, hover effect, rounded corners -->
         <button id="clear-filters" class="col-span-full justify-self-start mt-3 px-4 py-2 bg-red-500 text-white rounded h-[35px] text-sm hover:bg-red-600 cursor-pointer self-end">
             Clear All Filters
        </button>
    </div>
    <!-- End Filter Controls Section -->

    <!-- Loading Indicator: Hidden by default, centered text, padding, text style -->
    <div id="loading-indicator" class="hidden text-center p-5 text-lg text-blue-600 flex-shrink-0">
        Loading Table...
    </div>

    <!-- AG Grid Container: Takes remaining space, flex layout -->
    <div id="grid-container" class="flex-grow flex flex-col min-h-0">
        <!-- AG Grid Element: Takes space in container, width, min-height, margin -->
        <div id="myGrid" class="ag-theme-alpine flex-grow w-full min-h-[400px] mb-5"></div>
        <!-- AG Grid will be initialized here by JavaScript -->
    </div>
    <!-- End AG Grid Container -->


    <!-- ========= JAVASCRIPT SECTION ========= -->

    <!-- Load AG Grid Library -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>

    <!-- Sample Data (Unchanged) -->
    <script>
        const torrentData = [
          { hash_id:"b573e7a597f470fc", name: "kali-linux-2024.4-installer-amd64.iso", size: 4373655552, file_count: 1, first_seen: "2024-12-12T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "misc", dht_hits: 12408, peer_hits: 125 },
          { hash_id:"7b1490474e51536e", name: "kali-linux-2024.3-installer-amd64.iso", size: 4330174464, file_count: 1, first_seen: "2024-09-11T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "misc", dht_hits: 7948, peer_hits: 88 },
          { hash_id:"9fc151c1873df628", name: "kali-linux-2024.4-live-amd64.iso", size: 5041469440, file_count: 1, first_seen: "2024-12-11T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "misc", dht_hits: 6404, peer_hits: 136 },
          { hash_id:"a1b2c3d4e5f6a7b8", name: "ubuntu-24.04-desktop-amd64.iso", size: 3145728000, file_count: 1, first_seen: "2024-04-25T00:00:00Z", last_seen: "2025-03-31T00:00:00Z", is_ru: false, is_han: false, category: "linux", dht_hits: 25000, peer_hits: 512 },
          { hash_id:"f8e7d6c5b4a3f2e1", name: "some_movie_russian_translation.mkv", size: 1572864000, file_count: 1, first_seen: "2024-10-01T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: true, is_han: false, category: "movies", dht_hits: 500, peer_hits: 25 },
          { hash_id:"abcdef1234567890", name: "another_movie_original_audio.mp4", size: 2097152000, file_count: 1, first_seen: "2024-11-15T00:00:00Z", last_seen: "2025-04-01T00:00:00Z", is_ru: false, is_han: false, category: "movies", dht_hits: 1234, peer_hits: 56 },
           { hash_id:"fedcba9876543210", name: "linux_distro_image.img", size: 471859200, file_count: 1, first_seen: "2023-01-10T00:00:00Z", last_seen: "2025-02-28T00:00:00Z", is_ru: false, is_han: false, category: "linux", dht_hits: 8888, peer_hits: 111 },
           { hash_id:"1122334455667788", name: "archive_files.zip", size: 104857600, file_count: 50, first_seen: "2024-07-01T00:00:00Z", last_seen: "2025-03-15T00:00:00Z", is_ru: false, is_han: false, category: null, dht_hits: 300, peer_hits: 15 }, // Example with null category
        ];
    </script>

    <!-- AG Grid Initialization and Custom Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References (Unchanged) ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const categorySelect = document.getElementById('filter-category');
            const nameInput = document.getElementById('filter-name');
            const minSizeInput = document.getElementById('filter-min-size');
            const maxSizeInput = document.getElementById('filter-max-size');
            const isRuSelect = document.getElementById('filter-is_ru');
            const minDhtInput = document.getElementById('filter-min-dht');
            const clearFiltersButton = document.getElementById('clear-filters');
            const gridDiv = document.querySelector('#myGrid');

            let gridApi;

            // --- Helper Functions (Unchanged) ---
            function formatSize(bytes) { /* ... */ if (bytes === 0 || !bytes) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); const correctedIndex = Math.max(0, Math.min(i, sizes.length - 1)); return parseFloat((bytes / Math.pow(k, correctedIndex)).toFixed(1)) + ' ' + sizes[correctedIndex]; }
            function formatDate(dateString) { /* ... */ if (!dateString) return ''; try { const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } catch (e) { return dateString; } }
            function debounce(func, wait) { /* ... */ let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func.apply(this, args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

            // --- Category Filter Population (Unchanged) ---
            function populateCategoryFilter() {
                const uniqueCategories = [...new Set(torrentData.map(item => item.category).filter(cat => cat))].sort();
                uniqueCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                console.log('Category filter populated.');
            }

            // --- AG Grid Configuration (Updated suppressHeaderMenuButton) ---
            const columnDefs = [
                // *** FIXED: Replaced suppressMenu with suppressHeaderMenuButton ***
                { headerName: "Hash ID", field: "hash_id", filter: 'agTextColumnFilter', width: 160, suppressHeaderMenuButton: true },
                { headerName: "Name", field: "name", filter: 'agTextColumnFilter', width: 400, wrapText: true, autoHeight: true },
                {
                    headerName: "Size", field: "size", filter: 'agNumberColumnFilter', width: 120,
                    cellClass: 'text-right',
                    headerClass: 'text-right',
                    valueFormatter: params => formatSize(params.value)
                },
                { headerName: "Files", field: "file_count", type: 'numericColumn', filter: 'agNumberColumnFilter', width: 90 },
                {
                    headerName: "First Seen", field: "first_seen", filter: 'agDateColumnFilter', width: 140,
                    valueFormatter: params => formatDate(params.value),
                    valueGetter: params => params.data.first_seen ? new Date(params.data.first_seen) : null
                },
                {
                    headerName: "Last Seen", field: "last_seen", filter: 'agDateColumnFilter', width: 140,
                    valueFormatter: params => formatDate(params.value),
                    valueGetter: params => params.data.last_seen ? new Date(params.data.last_seen) : null
                },
                {
                    headerName: "Is RU", field: "is_ru", width: 90,
                    cellClass: 'text-center',
                    headerClass: 'text-center',
                    filter: 'agSetColumnFilter', valueFormatter: params => params.value ? 'Yes' : 'No', filterParams: { values: ['Yes', 'No'] }
                },
                {
                    headerName: "Is Han", field: "is_han", width: 90,
                    cellClass: 'text-center',
                    headerClass: 'text-center',
                    filter: 'agSetColumnFilter', valueFormatter: params => params.value ? 'Yes' : 'No', filterParams: { values: ['Yes', 'No'] }
                },
                { headerName: "Category", field: "category", filter: true, width: 120 },
                {
                    headerName: "DHT Hits", field: "dht_hits", type: 'numericColumn', filter: 'agNumberColumnFilter', width: 120,
                    valueFormatter: params => params.value?.toLocaleString() ?? '0'
                },
                {
                    headerName: "Peer Hits", field: "peer_hits", type: 'numericColumn', filter: 'agNumberColumnFilter', width: 120,
                    valueFormatter: params => params.value?.toLocaleString() ?? '0'
                }
            ];

            // AG Grid Options
            const gridOptions = {
                columnDefs: columnDefs,
                rowData: null,
                // *** Updated defaultColDef to remove suppressMenu if it was ever intended globally ***
                // If you want NO menus on ANY column by default, use suppressHeaderMenuButton here instead of suppressMenu
                defaultColDef: {
                    sortable: true,
                    resizable: true,
                    filter: true,
                    // suppressHeaderMenuButton: true, // Uncomment this to hide menu on ALL columns by default
                 },
                pagination: true, paginationPageSize: 50, paginationPageSizeSelector: [10, 25, 50, 100, 250, 500],
                isExternalFilterPresent: isExternalFilterPresent, doesExternalFilterPass: doesExternalFilterPass,
                onGridReady: (params) => {
                    gridApi = params.api;
                    console.log('AG Grid Ready');
                    setTimeout(() => {
                        if (typeof torrentData !== 'undefined') {
                            gridApi.setGridOption('rowData', torrentData);
                        } else {
                            console.error("torrentData is not defined!");
                        }
                        loadingIndicator.classList.add('hidden');
                    }, 50);
                },
                suppressBrowserResizeObserver: true, suppressColumnVirtualisation: false, suppressRowVirtualisation: false, ensureDomOrder: true, accentedSort: true,
            };

            // --- External Filter State and Logic (Unchanged logic) ---
            const externalFilterState = { name: '', category: '', minSizeMB: null, maxSizeMB: null, is_ru: '', minDht: null };
            function updateExternalFilterState() { /* ... (same logic) ... */ externalFilterState.name = nameInput.value.toLowerCase().trim(); externalFilterState.category = categorySelect.value; externalFilterState.minSizeMB = parseFloat(minSizeInput.value) || null; externalFilterState.maxSizeMB = parseFloat(maxSizeInput.value) || null; externalFilterState.is_ru = isRuSelect.value; externalFilterState.minDht = parseInt(minDhtInput.value) || null; if (gridApi) { gridApi.onFilterChanged(); } }
            function isExternalFilterPresent() { /* ... (same logic) ... */ return externalFilterState.name !== '' || externalFilterState.category !== '' || externalFilterState.minSizeMB !== null || externalFilterState.maxSizeMB !== null || externalFilterState.is_ru !== '' || externalFilterState.minDht !== null; }
            function doesExternalFilterPass(node) { /* ... (same logic) ... */ const rowData = node.data; const minSizeBytes = externalFilterState.minSizeMB !== null ? externalFilterState.minSizeMB * 1024 * 1024 : 0; const maxSizeBytes = externalFilterState.maxSizeMB !== null ? externalFilterState.maxSizeMB * 1024 * 1024 : Infinity; if (externalFilterState.name && !(rowData.name?.toLowerCase() || '').includes(externalFilterState.name)) return false; if (externalFilterState.category && rowData.category !== externalFilterState.category) return false; const size = rowData.size ?? 0; if (size < minSizeBytes || size > maxSizeBytes) return false; if (externalFilterState.is_ru !== "" && String(rowData.is_ru ?? false) !== externalFilterState.is_ru) return false; if (externalFilterState.minDht !== null && (rowData.dht_hits ?? 0) < externalFilterState.minDht) return false; return true; }

            const debouncedFilterUpdate = debounce(updateExternalFilterState, 350);

            // --- Setup Filter Event Listeners (Unchanged structure) ---
            nameInput.addEventListener('input', debouncedFilterUpdate);
            categorySelect.addEventListener('change', updateExternalFilterState);
            minSizeInput.addEventListener('input', debouncedFilterUpdate);
            maxSizeInput.addEventListener('input', debouncedFilterUpdate);
            minDhtInput.addEventListener('input', debouncedFilterUpdate);
            isRuSelect.addEventListener('change', updateExternalFilterState);
            clearFiltersButton.addEventListener('click', () => {
                nameInput.value = '';
                categorySelect.value = '';
                minSizeInput.value = '';
                maxSizeInput.value = '';
                isRuSelect.value = '';
                minDhtInput.value = '';
                updateExternalFilterState();
                if(gridApi) {
                    gridApi.setFilterModel(null);
                }
            });

            // --- Initialize AG Grid ---
            populateCategoryFilter();

            loadingIndicator.classList.remove('hidden');

            if (gridDiv) {
                 agGrid.createGrid(gridDiv, gridOptions);
            } else {
                console.error("AG Grid container '#myGrid' not found.");
                loadingIndicator.innerText = "Error: Grid container not found.";
                loadingIndicator.classList.remove('hidden');
            }

        }); // End DOMContentLoaded
    </script>

</body>
</html>