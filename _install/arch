# host
# ====
qemu-img create -f raw arch.img 64G


# in tty
# ======

# type blindly in qemu ncurses display
<tab><space>nomodeset<enter>

dhcpcd
ssh-keygen -A
echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config
/sbin/sshd
passwd

ssh -o 'StrictHostKeyChecking no' -o  'UserKnownHostsFile /dev/null' -p 10122 root@localhost


# after ssh
# =========

sgdisk --zap-all /dev/vda
sgdisk --clear /dev/vda
sgdisk -g /dev/vda
sgdisk --new 1:+2M:+256M --typecode=1:ef02 /dev/vda

sgdisk --attributes 1:set:2 /dev/vda
sgdisk --new 2::-0 --typecode=2:8300 /dev/vda

mkfs.ext4 -F /dev/vda1
mkfs.ext4 -F /dev/vda2
resize2fs -s /dev/vda1
dd bs=440 count=1 conv=notrunc if=/usr/lib/syslinux/bios/gptmbr.bin of=/dev/vda

mount /dev/vda2 /mnt/
mkdir /mnt/boot /mnt/shared
mount /dev/vda1 /mnt/boot

pacman-key --init
pacman-key --populate archlinux

genfstab -U /mnt > /mnt/etc/fstab
echo 'host0 /mnt/shared 9p trans=virtio,version=9p2000.L,_netdev 0 0' >> /mnt/etc/fstab                                                                            
pacstrap /mnt base base-devel

arch-chroot /mnt


# commands in chroot
# ==================

ln -sf /usr/share/zoneinfo/Europe/Warsaw /etc/localtime
hwclock --systohc

mkdir -p /etc/conf.d
echo keymap=pl > /etc/conf.d/keymaps
echo KEYMAP=pl > /etc/vconsole.conf

printf '%s\n%s\n' 'en_US.UTF-8 UTF-8' 'pl_PL.UTF-8 UTF-8' > /etc/locale.gen
locale-gen

echo arch > /etc/hostname
cat <<EOF > /etc/hosts
127.0.0.1        localhost local
::1              localhost local
EOF

pacman --noconfirm -Sy
pacman --noconfirm -S linux linux-lts openssh syslinux
pacman --noconfirm -S vim wget git dhcpcd usbutils lsof chrony bind-tools

mkdir -p /boot/syslinux
extlinux --install /boot/syslinux

cat <<EOF > /boot/syslinux/syslinux.cfg
PROMPT 0
DEFAULT arch-lts
TIMEOUT 10

LABEL arch-lts
MENU LABEL Arch Linux LTS
LINUX ../vmlinuz-linux-lts
APPEND root=/dev/vda2 rw net.ifnames=0 nomodeset quiet
INITRD ../initramfs-linux-lts.img

LABEL arch
MENU LABEL Arch Linux
LINUX ../vmlinuz-linux
APPEND root=/dev/vda2 rw net.ifnames=0 nomodeset quiet
INITRD ../initramfs-linux.img

LABEL arch-fallback
MENU LABEL Arch Linux fallback
LINUX ../vmlinuz-linux-lts
APPEND root=/dev/vda2 rw net.ifnames=0 nomodeset quiet
INITRD ../initramfs-linux.img
EOF

useradd -m -p '' x
usermod -a -G disk x
usermod -a -G lp x
usermod -a -G audio x
usermod -a -G input x
usermod -a -G video x
usermod -a -G tty x
usermod -a -G users x
usermod -a -G network x
usermod -a -G power x


# !!! manual step
mkdir -p /root/.ssh /home/x/.ssh
echo 'ssh-ed25519 <key>' > /root/.ssh/authorized_keys
echo 'ssh-ed25519 <key>' > /home/x/.ssh/authorized_keys
chmod 700 /root/.ssh/ /home/x/.ssh/
chmod 600 /root/.ssh/authorized_keys /home/x/.ssh/authorized_keys
chown -R x:x /home/x/
rm -f /etc/ssh/ssh_host_dsa_key* /etc/ssh/ssh_host_ecdsa_key*
ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key

# !!! (optional) manual step
echo 'ssh-ed25519 <key>' > /etc/ssh/ssh_host_ed25519_key.pub
cat <<EOF > /etc/ssh/ssh_host_ed25519_key
-----BEGIN OPENSSH PRIVATE KEY-----
<...>
-----END OPENSSH PRIVATE KEY-----
EOF
chmod 600 /etc/ssh/ssh_host_ed25519_key

systemctl enable sshd
systemctl enable chronyd
systemctl enable dhcpcd

passwd
passwd x

# install cli pkgs
p=
p+=' archlinux-tools linux-tools multilib-devel dos2unix openvpn avahi sqlmap'
p+=' vim libpciaccess clang llvm ninja go rust i7z traceroute nss-mdns wpscan'
p+=' dotnet-runtime iperf3 postgresql sqlite meson man-pages nfs-utils zaproxy'
p+=' busybox bc lxc cpio zip unzip unrar p7zip rsync p7zip imagemagick fq npm'
p+=' cmake strace arp-scan mtr iputils inetutils fping tcpdump dmidecode nikto'
p+=' termshark vlock gptfdisk dosfstools cronie mtools tmux metasploit libnfs'
p+=' sysstat iotop efivar efitools efibootmgr checksec acpi exploitdb sslsplit'
p+=' syslog-ng iw wpa_supplicant hostapd wireguard-tools nmap ttf-dejavu maven'
p+=' socat wol smartmontools hdparm flashrom task vifm ncdu python-socksio ghc'
p+=' transmission-cli geoip geoip-database android-tools python-shodan ipython'
p+=' acme aircrack-ng dnsmasq fetchmail httpie distcc ccache ssh-audit gcc-ada'
p+=' iftop iodine irssi lftp lorcon macchanger man w3m net-snmp mariadb jadx'
p+=' mitmproxy mktorrent nethogs siege speedtest-cli tor geoip-database-extra'
p+=' vnstat whois  fdupes hplip lshw powertop pigz pixz mercurial stack hwinfo'
p+=' sl stress testdisk asciidoc ebook-tools xmlto w3m python-beautifulsoup4'
p+=' smbclient samba xmlstarlet php enca uchardet man-pages proxychains mutt'
p+=' scapy python-scapy python-pip bpython expect python-lxml shellcheck'
p+=' tesseract tesseract-data-eng jdk-openjdk jdk11-openjdk jdk17-openjdk ovmf'
p+=' arch-wiki-docs cabal-install cdrkit fuseiso mlocate atftp figlet uchardet'
p+=' fbset tlp gdisk cdrtools rtorrent msmtp links rsync cowsay elinks rclone'
p+=' perl-text-charwidth subversion python-pandas splint cmus yt-dlp sc cmark'
p+=' john hashcat hashcat-utils subdl ebook-tools latex2html latex2rtf dblatex'
p+=' texlive-most dot2tex graphviz pandoc dialog psutils python-html2text tidy'
p+=' php-tidy asciinema weechat guile hunspell-en_us hunspell-pl tcc fastjar'
p+=' gpsd modemmanager firejail python-pyserial docker iptstate quota-tools jq'
p+=' vim-spell-pl checkbashisms dash ansible ansible-lint iucode-tool tree nnn'
p+=' ranger shellharden units logwatch logrotate tcl chrpath openssl-1.1'
p+=' jre-openjdk jre11-openjdk jre17-openjdk'

pacman --noconfirm -S ${p}
pacman --noconfirm -Scc

exit
sync
poweroff


# config after reboot
# ===================

# proxychains
sed -i  's|^#quiet_mode$|quiet_mode|g' /etc/proxychains.conf
sed -i  's|^socks4|#socks4|g' /etc/proxychains.conf
echo 'http    127.0.0.1 8080' >> /etc/proxychains.conf

# configure postgres for metasploit
usermod -a -G postgres x
su - postgres -c 'initdb -D /var/lib/postgres/data'
systemctl status postgresql
systemctl enable postgresql

# MANUAL STEP! enter password:
su - postgres -c 'createuser msf -P -S -R -D'

su - postgres -c 'createdb -O msf msf'

su - x

mkdir -p /home/x/.msf4
cat <<EOF > /home/x/.msf4/database.yml
production:
   adapter: postgresql
   database: msf
   username: msf
   password: 'ffL_msf.3..:::'
   host: 127.0.0.1
   port: 5432
   pool: 75
   timeout: 5
EOF
chown x:x /home/x/.msf4/database.yml

# mitmproxy
mkdir -p /home/x/.mitmproxy
cat <<EOF > /home/x/.mitmproxy/config.yaml
listen_host: 127.0.0.1
listen_port: 8080
console_mouse: false
console_palette: lowdark
view_order: time
EOF

# zap
pip install python-owasp-zap-v2.4
pip install PyJWT

# mongodb manual steps as a user
git clone https://aur.archlinux.org/mongosh-bin.git
cd mongosh-bin && makepkg
exit
pacman -U /home/x/mongosh-bin/mongosh*.tar.zst
su - x

git clone https://aur.archlinux.org/mongodb-bin.git
cd mongodb-bin && makepkg
exit
pacman -U /home/x/mongodb-bin/mongodb*.tar.zst
su - x

# for a wordpress exploit php/webapps/47361.pl
perl -MCPAN -e shell
cpan[1]> install WWW::UserAgent::Random

cat /dev/zero >> /root/zeros.bin 2>&1 ||:; sync; rm /root/zeros.bin && sync
poweroff


# gui programs
# ============

echo arch-gui > /etc/hostname
sed -i 's| nomodeset||g' /boot/syslinux/syslinux.cfg

pacman --noconfirm -S xorg-server xorg-xinit xorg-xrandr i3
pacman --noconfirm -S alsa-utils alsa-plugins pulseaudio-alsa pulseaudio libpulse pavucontrol
pacman --noconfirm -S qemu-guest-agent spice-vdagent
pacman --noconfirm -S gimp libreoffice hunspell-en_US hunspell-pl
pacman --noconfirm -S ttf-inconsolata ttf-dejavu ttf-droid ttf-liberation terminus-font
pacman --noconfirm -S ttf-font-awesome noto-fonts noto-fonts-extra


# gui tools
p=''
p+='wireshark-qt tigervnc feh zathura zathura-pdf-poppler gimp remmina '

electrum



fc-cache -f
systemctl enable qemu-guest-agent

mkdir -p '/etc/systemd/system/getty@tty1.service.d'
cat <<EOF >> /etc/systemd/system/getty\@tty1.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty -o '-p -f -- \\\\u' --noclear --autologin x - \$TERM
EOF

cat <<EOF >> /etc/modprobe.d/kms.conf
options bochs modeset=1
options qxl modeset=1
EOF

mkdir -p /etc/modules-load.d
cat <<EOF >> /etc/modules-load.d/xorg.conf
bochs
qxl
snd_seq
EOF

cat <<EOF > /etc/X11/xorg.conf.d/10-keyboard.conf
Section "InputClass"
        Identifier      "system-keyboard"
        MatchIsKeyboard "on"
        Option          "XkbLayout"             "pl,us"
        Option          "GrabDevice"            "False"
EndSection

# enable switching to tty
Section "Serverflags"
        Option "DontVTSwitch" "off"
EndSection
EOF

cat <<EOF > /etc/X11/xorg.conf.d/20-video.conf
Section "Monitor"
        Identifier      "Virtual-1"
        VertRefresh     60
        Modeline        "1920x1080_60.00"  173.00  1920 2048 2248 2576  1080 1083 1088 1120 -hsync +vsync
        Option          "PreferredMode"         "1920x1080_60.00"
EndSection

Section "Device"
        Identifier  "Card0"
        Driver      "modesetting"
        BusID       "PCI:0:3:0"
EndSection

Section "Screen"
        Identifier "Screen0"
        Device     "Card0"
        Monitor    "Virtual-1"
        SubSection "Display"
                Viewport   0 0
                Depth     24
        EndSubSection
EndSection
EOF

cat > /home/x/.Xresources << EOF
Xft.antialias: 0
Xft.rgba:      rgb
Xft.autohint:  0
Xft.hinting:   1
Xft.hintstyle: hintslight
EOF
 

# reboot
# ======
# mostly to get rid of nomodeset
reboot

X -configure
mv xorg.conf.new /etc/X11/xorg.conf

git clone https://git.suckless.org/dwm
wget https://dwm.suckless.org/patches/autostart/dwm-autostart-20210120-cb3f58a.diff
cd dwm
git apply ../dwm-autostart-20210120-cb3f58a.diff
cp config.def.h config.h
sed -i 's|MODKEY Mod1Mask|MODKEY Mod4Mask|' config.h
sed -i 's|#005577|#005c35|' config.h
make clean install
mkdir /home/x/.dwm/
echo firefox > /home/x/.dwm/autostart.sh
chmod +x /home/x/.dwm/autostart.sh
cd
git clone https://git.suckless.org/st
cd st && make clean install

echo 'exec dwm' > /home/x/.xinitrc
echo '[ -z "${DISPLAY}" ] && [ "$(tty)" = /dev/tty1 ] && startx' >> /home/x/.bash_profile
chown -R x:x /home/x/

pacman -Sc
sync

reboot

